---
- name: Kadeem Infrastructure Setup
  hosts: db_server
  gather_facts: yes

  pre_tasks:
    - name: Validate required configuration variables
      ansible.builtin.assert:
        that:
          - database_url | default('') | length > 0
          - riot_api_key | default('') | length > 0
          - twitch_client_id | default('') | length > 0
          - twitch_client_secret | default('') | length > 0
          - supabase_jwks_url | default('') | length > 0
          - frontend_domain | default('') | length > 0
          - api_version | default('') | length > 0
          - api_port | default('') | length > 0
          - letsencrypt_email | default('') | length > 0
          - cloudflare_api_token | default('') | length > 0
          - ansible_become_password | default('') | length > 0
        fail_msg: >-
          Missing required deploy variables. Define them in
          ansible/group_vars/db_server/vault.yml

    - name: Display target host information
      ansible.builtin.debug:
        msg:
          - "Target Host: {{ ansible_host }}"
          - "SSH User: {{ ansible_user }}"
          - "OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
  
  roles:
    - role: postgresql
      tags: ['postgresql', 'database', 'backup']
    
    - role: nginx
      tags: ['nginx', 'web', 'ssl']
    
    - role: server
      tags: ['server', 'daemon', 'api']

    - role: github_runner
      tags: ['runner', 'github-actions', 'deploy']
  
  post_tasks:
    - name: Infrastructure setup complete
      ansible.builtin.debug:
        msg:
          - "✅ PostgreSQL installation and configuration complete!"
          - "Connection: {{ db_user }}@{{ db_host }}:{{ db_port }}/{{ db_name }}"
          - "Backup timer: kadeem-backup.timer (daily at {{ backup_time }})"
          - "✅ Nginx configured for {{ api_domain }}"
          - "✅ Kadeem daemon service installed"
          - "✅ GitHub self-hosted runner installed"
          - ""
          - "Next steps:"
          - "1. Point DNS: {{ api_domain }} → {{ ansible_host }}"
          - "2. Trigger CI/CD from GitHub Actions"
          - "3. Test: https://{{ api_domain }}/health"
