---
- name: Kadeem Infrastructure Setup
  hosts: db_server
  gather_facts: yes
  
  vars:
    database_url: "{{ lookup('env', 'DATABASE_URL') }}"
  
  pre_tasks:
    - name: Check if DATABASE_URL is set
      ansible.builtin.fail:
        msg: "DATABASE_URL environment variable is not set. Please set it before running this playbook."
      when: database_url is not defined or database_url == ''
    
    - name: Display target host information
      ansible.builtin.debug:
        msg:
          - "Target Host: {{ ansible_host }}"
          - "SSH User: {{ ansible_user }}"
          - "OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
  
  roles:
    - role: postgresql
      tags: ['postgresql', 'database', 'backup']
    
    - role: nginx
      tags: ['nginx', 'web', 'ssl']
    
    - role: server
      tags: ['server', 'daemon', 'api']

    - role: github_runner
      tags: ['runner', 'github-actions', 'deploy']
  
  post_tasks:
    - name: Infrastructure setup complete
      ansible.builtin.debug:
        msg:
          - "✅ PostgreSQL installation and configuration complete!"
          - "Connection: {{ db_user }}@{{ db_host }}:{{ db_port }}/{{ db_name }}"
          - "Backup timer: kadeem-backup.timer (daily at {{ backup_time }})"
          - "✅ Nginx configured for {{ api_domain }}"
          - "✅ Kadeem daemon service installed"
          - "✅ GitHub self-hosted runner installed"
          - ""
          - "Next steps:"
          - "1. Point DNS: {{ api_domain }} → {{ ansible_host }}"
          - "2. Trigger CI/CD from GitHub Actions"
          - "3. Test: https://{{ api_domain }}/health"
