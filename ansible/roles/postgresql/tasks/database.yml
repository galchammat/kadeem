---
- name: Display parsed database credentials
  ansible.builtin.debug:
    msg:
      - "Database: {{ db_name }}"
      - "User: {{ db_user }}"
      - "Host: {{ db_host }}"
      - "Port: {{ db_port }}"

- name: Check if database exists
  ansible.builtin.shell: |
    sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'"
  register: db_exists
  changed_when: false
  failed_when: false
  when: not ansible_check_mode

- name: Create database
  ansible.builtin.shell: |
    sudo -u postgres psql -c "CREATE DATABASE {{ db_name }};"
  when: 
    - not ansible_check_mode
    - db_exists.stdout != '1'
  become: yes

- name: Check if database user exists
  ansible.builtin.shell: |
    sudo -u postgres psql -tAc "SELECT 1 FROM pg_user WHERE usename='{{ db_user }}'"
  register: user_exists
  changed_when: false
  failed_when: false
  when: not ansible_check_mode

- name: Create database user
  ansible.builtin.shell: |
    sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH ENCRYPTED PASSWORD '{{ db_password }}';"
  when: 
    - not ansible_check_mode
    - user_exists.stdout != '1'
  become: yes
  no_log: true

- name: Update user password if user exists
  ansible.builtin.shell: |
    sudo -u postgres psql -c "ALTER USER {{ db_user }} WITH ENCRYPTED PASSWORD '{{ db_password }}';"
  when: 
    - not ansible_check_mode
    - user_exists.stdout == '1'
  become: yes
  no_log: true

- name: Grant all privileges on database to user
  ansible.builtin.shell: |
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"
  become: yes
  when: not ansible_check_mode

- name: Set database owner
  ansible.builtin.shell: |
    sudo -u postgres psql -c "ALTER DATABASE {{ db_name }} OWNER TO {{ db_user }};"
  become: yes
  when: not ansible_check_mode
