---
- name: Create backup script directory
  ansible.builtin.file:
    path: "{{ backup_script_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Create shared environment group
  ansible.builtin.group:
    name: "{{ kadeem_env_group }}"
    system: yes
    state: present
  become: yes

- name: Deploy backup script
  ansible.builtin.template:
    src: backup-script.sh.j2
    dest: "{{ backup_script_path }}"
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Create /etc/kadeem directory
  ansible.builtin.file:
    path: /etc/kadeem
    state: directory
    owner: root
    group: "{{ kadeem_env_group }}"
    mode: '0750'
  become: yes

- name: Deploy environment file for backup script
  ansible.builtin.template:
    src: backup-env.j2
    dest: /etc/kadeem/kadeem.env
    owner: root
    group: "{{ kadeem_env_group }}"
    mode: '0640'
  become: yes
  diff: false

- name: Deploy backup systemd service
  ansible.builtin.template:
    src: backup.service.j2
    dest: /etc/systemd/system/kadeem-backup.service
    owner: root
    group: root
    mode: '0644'
  become: yes

- name: Deploy backup systemd timer
  ansible.builtin.template:
    src: backup.timer.j2
    dest: /etc/systemd/system/kadeem-backup.timer
    owner: root
    group: root
    mode: '0644'
  become: yes

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes
  become: yes
  when: not ansible_check_mode

- name: Enable and start backup timer
  ansible.builtin.systemd:
    name: kadeem-backup.timer
    enabled: yes
    state: started
  become: yes
  when: not ansible_check_mode

- name: Check backup timer status
  ansible.builtin.shell: systemctl status kadeem-backup.timer --no-pager
  register: timer_status
  changed_when: false
  failed_when: false
  when: not ansible_check_mode

- name: Display backup timer status
  ansible.builtin.debug:
    var: timer_status.stdout_lines
  when: not ansible_check_mode
