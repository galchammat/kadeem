#!/bin/bash
# PostgreSQL Backup Script
# Managed by Ansible - Do not edit manually

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# Load environment variables
if [ -f "/etc/kadeem/kadeem.env" ]; then
    source /etc/kadeem/kadeem.env
elif [ -f "/etc/kadeem/.env" ]; then
    source /etc/kadeem/.env
else
    log_error "kadeem env file not found"
    exit 1
fi

# Configuration
BACKUP_HOST="{{ backup_host }}"
BACKUP_USER="{{ backup_user }}"
BACKUP_PATH="{{ backup_path }}"
RETENTION_DAYS="{{ backup_retention_days }}"
DISCORD_WEBHOOK_URL="${DISCORD_WEBHOOK_URL:-}"

# Parse DATABASE_URL
DB_USER=$(echo "$DATABASE_URL" | sed -n 's|.*://\([^:]*\):.*|\1|p')
DB_PASS=$(echo "$DATABASE_URL" | sed -n 's|.*://[^:]*:\([^@]*\)@.*|\1|p')
DB_HOST=$(echo "$DATABASE_URL" | sed -n 's|.*@\([^:]*\):.*|\1|p')
DB_NAME=$(echo "$DATABASE_URL" | sed -n 's|.*/\([^?]*\).*|\1|p')

# Backup filename
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="kadeem_backup_${TIMESTAMP}.sql.gz"
LOCAL_BACKUP="/tmp/$BACKUP_FILE"

log_info "Starting PostgreSQL backup..."
log_info "Database: $DB_NAME on $DB_HOST"

# Create backup
if PGPASSWORD="$DB_PASS" pg_dump -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" \
    --format=plain \
    --no-owner \
    --no-privileges | gzip > "$LOCAL_BACKUP"; then
    BACKUP_SIZE=$(du -h "$LOCAL_BACKUP" | cut -f1)
    log_info "Backup created: $BACKUP_FILE ($BACKUP_SIZE)"
else
    log_error "Backup failed!"
    exit 1
fi

# Transfer to backup host via Tailscale
log_info "Transferring backup to $BACKUP_HOST:$BACKUP_PATH..."

# Create remote directory if needed
if ssh "${BACKUP_USER}@${BACKUP_HOST}" "mkdir -p $BACKUP_PATH" 2>/dev/null; then
    log_info "Remote directory ready"
else
    log_error "Failed to create remote directory"
    rm "$LOCAL_BACKUP"
    exit 1
fi

# Copy backup
if scp "$LOCAL_BACKUP" "${BACKUP_USER}@${BACKUP_HOST}:${BACKUP_PATH}/"; then
    log_info "Backup transferred successfully"
else
    log_error "Failed to transfer backup"
    rm "$LOCAL_BACKUP"
    exit 1
fi

# Clean up local backup
rm "$LOCAL_BACKUP"

# Clean old backups on remote
log_info "Cleaning old backups (keeping last $RETENTION_DAYS days)..."
ssh "${BACKUP_USER}@${BACKUP_HOST}" \
    "find $BACKUP_PATH -name 'kadeem_backup_*.sql.gz' -mtime +$RETENTION_DAYS -delete" || \
    log_warn "Failed to clean old backups"

# List recent backups
log_info "Recent backups on $BACKUP_HOST:"
ssh "${BACKUP_USER}@${BACKUP_HOST}" \
    "ls -lh $BACKUP_PATH/kadeem_backup_*.sql.gz 2>/dev/null | tail -5" || log_warn "No backups found"

log_info "Backup complete!"

# Send Discord notification
if [ -n "$DISCORD_WEBHOOK_URL" ]; then
    curl -X POST "$DISCORD_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"Kadeem database backup completed successfully\n**File:** $BACKUP_FILE\n**Size:** $BACKUP_SIZE\"}" \
        &> /dev/null || log_warn "Failed to send Discord notification"
fi

exit 0
