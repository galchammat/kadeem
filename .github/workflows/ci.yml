name: CI

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_all:
        description: Run all component checks and builds
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  changes:
    name: Detect Changed Components
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            server:
              - 'packages/server/**'
            web:
              - 'packages/web/**'

  server-test:
    name: Server Test
    if: needs.changes.outputs.server == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true')
    needs: changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('packages/server/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: packages/server/coverage.out
          flags: unittests
          fail_ci_if_error: false

  server-lint:
    name: Server Lint
    if: needs.changes.outputs.server == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true')
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
          working-directory: packages/server

  server-build:
    name: Server Build
    if: needs.changes.outputs.server == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true')
    needs:
      - changes
      - server-test
      - server-lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build daemon
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.version=${{ github.sha }}" \
            -o daemon \
            cmd/daemon/main.go

      - name: Upload daemon artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: daemon-binary
          path: packages/server/daemon
          retention-days: 7

  web-lint:
    name: Web Lint
    if: needs.changes.outputs.web == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true')
    needs: changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm lint

  web-build:
    name: Web Build
    if: needs.changes.outputs.web == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true')
    needs:
      - changes
      - web-lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm build

  ci-gate:
    name: CI Gate
    if: always()
    needs:
      - changes
      - server-test
      - server-lint
      - server-build
      - web-lint
      - web-build
    runs-on: ubuntu-latest
    steps:
      - name: Validate changed component jobs
        run: |
          run_all="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true' }}"
          server_changed="${{ needs.changes.outputs.server }}"
          web_changed="${{ needs.changes.outputs.web }}"

          server_test_result="${{ needs.server-test.result }}"
          server_lint_result="${{ needs.server-lint.result }}"
          server_build_result="${{ needs.server-build.result }}"
          web_lint_result="${{ needs.web-lint.result }}"
          web_build_result="${{ needs.web-build.result }}"

          if [ "$run_all" = "true" ]; then
            if [ "$server_test_result" != "success" ] || [ "$server_lint_result" != "success" ] || [ "$server_build_result" != "success" ] || [ "$web_lint_result" != "success" ] || [ "$web_build_result" != "success" ]; then
              echo "run_all requested but not all component jobs succeeded"
              echo "server-test=$server_test_result"
              echo "server-lint=$server_lint_result"
              echo "server-build=$server_build_result"
              echo "web-lint=$web_lint_result"
              echo "web-build=$web_build_result"
              exit 1
            fi
          fi

          if [ "$server_changed" = "true" ]; then
            if [ "$server_test_result" != "success" ] || [ "$server_lint_result" != "success" ] || [ "$server_build_result" != "success" ]; then
              echo "Server changed but server pipeline did not fully succeed"
              echo "server-test=$server_test_result"
              echo "server-lint=$server_lint_result"
              echo "server-build=$server_build_result"
              exit 1
            fi
          fi

          if [ "$web_changed" = "true" ]; then
            if [ "$web_lint_result" != "success" ] || [ "$web_build_result" != "success" ]; then
              echo "Web changed but web pipeline did not fully succeed"
              echo "web-lint=$web_lint_result"
              echo "web-build=$web_build_result"
              exit 1
            fi
          fi

          echo "All changed components passed required jobs"
