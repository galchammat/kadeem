name: CI and Deploy

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      rollback:
        description: Rollback to previous version
        required: false
        type: boolean
        default: false
      run_all:
        description: Run all component checks and deploy
        required: false
        type: boolean
        default: false

jobs:
  changes:
    name: Detect Changed Components
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true'
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            server:
              - 'packages/server/**'
            web:
              - 'packages/web/**'

  server-test:
    name: Server Test
    if: >-
      (github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true') &&
      (needs.changes.outputs.server == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true'))
    needs: changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('packages/server/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: packages/server/coverage.out
          flags: unittests
          fail_ci_if_error: false

  server-lint:
    name: Server Lint
    if: >-
      (github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true') &&
      (needs.changes.outputs.server == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true'))
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
          working-directory: packages/server

  server-build:
    name: Server Build
    if: >-
      (github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true') &&
      (needs.changes.outputs.server == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true'))
    needs:
      - changes
      - server-test
      - server-lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build daemon
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.version=${{ github.sha }}" \
            -o daemon \
            cmd/daemon/main.go

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: daemon-binary
          path: packages/server/daemon
          retention-days: 7

  web-lint:
    name: Web Lint
    if: >-
      (github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true') &&
      (needs.changes.outputs.web == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true'))
    needs: changes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Typecheck
        run: pnpm lint

  web-build:
    name: Web Build
    if: >-
      (github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true') &&
      (needs.changes.outputs.web == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true'))
    needs:
      - changes
      - web-lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/web
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm build

  ci-gate:
    name: CI Gate
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.rollback != 'true'
    needs:
      - changes
      - server-test
      - server-lint
      - server-build
      - web-lint
      - web-build
    runs-on: ubuntu-latest
    steps:
      - name: Validate changed component jobs
        run: |
          run_all="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_all == 'true' }}"
          server_changed="${{ needs.changes.outputs.server }}"
          web_changed="${{ needs.changes.outputs.web }}"

          server_test_result="${{ needs.server-test.result }}"
          server_lint_result="${{ needs.server-lint.result }}"
          server_build_result="${{ needs.server-build.result }}"
          web_lint_result="${{ needs.web-lint.result }}"
          web_build_result="${{ needs.web-build.result }}"

          if [ "$run_all" = "true" ]; then
            if [ "$server_test_result" != "success" ] || [ "$server_lint_result" != "success" ] || [ "$server_build_result" != "success" ] || [ "$web_lint_result" != "success" ] || [ "$web_build_result" != "success" ]; then
              echo "run_all requested but not all component jobs succeeded"
              echo "server-test=$server_test_result"
              echo "server-lint=$server_lint_result"
              echo "server-build=$server_build_result"
              echo "web-lint=$web_lint_result"
              echo "web-build=$web_build_result"
              exit 1
            fi
          fi

          if [ "$server_changed" = "true" ]; then
            if [ "$server_test_result" != "success" ] || [ "$server_lint_result" != "success" ] || [ "$server_build_result" != "success" ]; then
              echo "Server changed but server pipeline did not fully succeed"
              echo "server-test=$server_test_result"
              echo "server-lint=$server_lint_result"
              echo "server-build=$server_build_result"
              exit 1
            fi
          fi

          if [ "$web_changed" = "true" ]; then
            if [ "$web_lint_result" != "success" ] || [ "$web_build_result" != "success" ]; then
              echo "Web changed but web pipeline did not fully succeed"
              echo "web-lint=$web_lint_result"
              echo "web-build=$web_build_result"
              exit 1
            fi
          fi

          echo "All changed components passed required jobs"

  deploy:
    name: Deploy to Machine B
    needs:
      - changes
      - server-build
      - ci-gate
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.server == 'true') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.rollback != 'true' && github.event.inputs.run_all == 'true' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-daemon-main
      cancel-in-progress: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download daemon binary
        uses: actions/download-artifact@v4
        with:
          name: daemon-binary

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          tags: tag:ci

      - name: Backup current daemon
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo cp /opt/kadeem/bin/daemon /opt/kadeem/bin/daemon.backup || true"

      - name: Deploy daemon binary
        run: |
          scp daemon ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/daemon

          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo mv /tmp/daemon /opt/kadeem/bin/daemon && \
             sudo chmod +x /opt/kadeem/bin/daemon && \
             sudo chown kadeem:kadeem /opt/kadeem/bin/daemon"

      - name: Set up Go on remote
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "which go || (curl -OL https://go.dev/dl/go1.23.6.linux-amd64.tar.gz && \
             sudo rm -rf /usr/local/go && \
             sudo tar -C /usr/local -xzf go1.23.6.linux-amd64.tar.gz && \
             echo 'export PATH=\$PATH:/usr/local/go/bin' | sudo tee -a /etc/profile)"

      - name: Run migrations
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "cd /opt/kadeem/repo/packages/server && \
             export PATH=\$PATH:/usr/local/go/bin && \
             export DATABASE_URL='${{ secrets.DATABASE_URL }}' && \
             go run cmd/migrate/main.go up"

      - name: Restart daemon
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo systemctl restart kadeem-daemon"

      - name: Wait for daemon startup
        run: sleep 5

      - name: Health check
        id: healthcheck
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo systemctl is-active kadeem-daemon"

      - name: Get daemon logs
        if: always()
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo journalctl -u kadeem-daemon -n 50 --no-pager"

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo mv /opt/kadeem/bin/daemon.backup /opt/kadeem/bin/daemon && \
             sudo systemctl restart kadeem-daemon" || true

      - name: Send Discord notification on success
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚úÖ Deployment Successful",
                "description": "Kadeem daemon deployed to Machine B",
                "color": 3066993,
                "fields": [
                  {"name": "Commit", "value": "'"${{ github.sha }}"'", "inline": true},
                  {"name": "Branch", "value": "'"${{ github.ref_name }}"'", "inline": true},
                  {"name": "Author", "value": "'"${{ github.actor }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

      - name: Send Discord notification on failure
        if: failure()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Deployment Failed",
                "description": "Kadeem daemon deployment failed and was rolled back",
                "color": 15158332,
                "fields": [
                  {"name": "Commit", "value": "'"${{ github.sha }}"'", "inline": true},
                  {"name": "Branch", "value": "'"${{ github.ref_name }}"'", "inline": true},
                  {"name": "Author", "value": "'"${{ github.actor }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback == 'true'
    concurrency:
      group: deploy-daemon-main
      cancel-in-progress: false
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          tags: tag:ci

      - name: Rollback to backup
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "sudo mv /opt/kadeem/bin/daemon.backup /opt/kadeem/bin/daemon && \
             sudo systemctl restart kadeem-daemon"

      - name: Send Discord notification
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üîÑ Manual Rollback",
                "description": "Kadeem daemon rolled back to previous version",
                "color": 16776960,
                "fields": [
                  {"name": "Triggered by", "value": "'"${{ github.actor }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'
