name: CD

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      rollback:
        description: Rollback to previous version
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: read

concurrency:
  group: deploy-daemon-main
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Machine B
    if: >-
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on:
      - self-hosted
      - linux
      - x64
      - machine-b
      - deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download daemon artifact
        uses: actions/download-artifact@v4
        with:
          name: daemon-binary
          path: .
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          if-no-artifact-found: ignore

      - name: Check daemon artifact availability
        id: artifact
        run: |
          if [ -f daemon ]; then
            chmod +x daemon
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip deploy when daemon artifact is absent
        if: steps.artifact.outputs.found != 'true'
        run: echo "No server artifact produced by CI; skipping deployment."

      - name: Set up Go
        if: steps.artifact.outputs.found == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Backup current daemon
        if: steps.artifact.outputs.found == 'true'
        run: sudo cp /opt/kadeem/bin/daemon /opt/kadeem/bin/daemon.backup || true

      - name: Deploy daemon binary
        if: steps.artifact.outputs.found == 'true'
        run: |
          mv ./daemon /tmp/kadeem-daemon
          sudo mv /tmp/kadeem-daemon /opt/kadeem/bin/daemon
          sudo chmod +x /opt/kadeem/bin/daemon

      - name: Run migrations
        if: steps.artifact.outputs.found == 'true'
        run: |
          set -a
          source /etc/kadeem/kadeem.env
          set +a
          cd "${GITHUB_WORKSPACE}/packages/server"
          go run cmd/migrate/main.go up

      - name: Restart daemon
        if: steps.artifact.outputs.found == 'true'
        run: sudo systemctl restart kadeem-daemon

      - name: Wait for daemon startup
        if: steps.artifact.outputs.found == 'true'
        run: sleep 5

      - name: Health check
        if: steps.artifact.outputs.found == 'true'
        run: sudo systemctl is-active kadeem-daemon

      - name: Get daemon logs
        if: always() && steps.artifact.outputs.found == 'true'
        run: sudo journalctl -u kadeem-daemon -n 50 --no-pager

      - name: Rollback on failure
        if: failure() && steps.artifact.outputs.found == 'true'
        run: |
          sudo mv /opt/kadeem/bin/daemon.backup /opt/kadeem/bin/daemon
          sudo systemctl restart kadeem-daemon || true

      - name: Send Discord notification on success
        if: success() && steps.artifact.outputs.found == 'true'
        run: |
          source /etc/kadeem/kadeem.env
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚úÖ Deployment Successful",
                "description": "Kadeem daemon deployed to Machine B",
                "color": 3066993,
                "fields": [
                  {"name": "Commit", "value": "'"${{ github.event.workflow_run.head_sha }}"'", "inline": true},
                  {"name": "Branch", "value": "'"${{ github.event.workflow_run.head_branch }}"'", "inline": true},
                  {"name": "Actor", "value": "'"${{ github.event.workflow_run.actor.login }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

      - name: Send Discord notification on failure
        if: failure() && steps.artifact.outputs.found == 'true'
        run: |
          source /etc/kadeem/kadeem.env
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "‚ùå Deployment Failed",
                "description": "Kadeem daemon deployment failed and was rolled back",
                "color": 15158332,
                "fields": [
                  {"name": "Commit", "value": "'"${{ github.event.workflow_run.head_sha }}"'", "inline": true},
                  {"name": "Branch", "value": "'"${{ github.event.workflow_run.head_branch }}"'", "inline": true},
                  {"name": "Actor", "value": "'"${{ github.event.workflow_run.actor.login }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

  rollback:
    name: Rollback Deployment
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback == 'true'
    runs-on:
      - self-hosted
      - linux
      - x64
      - machine-b
      - deploy
    steps:
      - name: Rollback to backup
        run: |
          sudo mv /opt/kadeem/bin/daemon.backup /opt/kadeem/bin/daemon
          sudo systemctl restart kadeem-daemon

      - name: Send Discord notification
        run: |
          source /etc/kadeem/kadeem.env
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üîÑ Manual Rollback",
                "description": "Kadeem daemon rolled back to previous version",
                "color": 16776960,
                "fields": [
                  {"name": "Triggered by", "value": "'"${{ github.actor }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'
